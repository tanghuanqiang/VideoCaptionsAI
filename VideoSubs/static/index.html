
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½å­—å¹•ç”Ÿæˆå™¨</title>
  <style>
    body { font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif; margin: 0; background: #f4f6fb; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #0001; padding: 32px; }
    h1 { text-align: center; margin-bottom: 32px; }
    .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 24px; }
    .tab { flex: 1; text-align: center; padding: 16px 0; cursor: pointer; font-size: 18px; color: #888; transition: color 0.2s; }
    .tab.active { color: #1976d2; border-bottom: 3px solid #1976d2; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .box { margin-bottom: 20px; }
    .result { white-space: pre-wrap; background: #f8f8f8; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .row { display: flex; gap: 16px; align-items: center; margin-bottom: 16px; }
    label { min-width: 80px; }
    input, select, textarea { padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 15px; }
    button { background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 10px 24px; font-size: 16px; cursor: pointer; margin-top: 8px; }
    button:hover { background: #1565c0; }
    .subtitle-edit { width: 100%; min-height: 80px; font-family: inherit; }
    .chat-box { background: #f8f8f8; border-radius: 8px; padding: 16px; height: 350px; overflow-y: auto; margin-bottom: 16px; border: 1px solid #e0e0e0; }
    .chat-msg { margin-bottom: 18px; }
    .chat-user { color: #1976d2; font-weight: bold; }
    .chat-ai { color: #388e3c; font-weight: bold; }
    .thinking { color: #aaa; font-style: italic; }
    .chat-input-row { display: flex; gap: 8px; }
    .chat-input { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ æ™ºèƒ½å­—å¹•ç”Ÿæˆå™¨</h1>
    <div class="tabs">
      <div class="tab active" onclick="showTab(0)">ä¸€é”®ç”Ÿæˆå­—å¹•</div>
      <div class="tab" onclick="showTab(1)">æ¥å£å·¥å…·ç®±</div>
      <div class="tab" onclick="showTab(2)">æ™ºèƒ½å¯¹è¯</div>
    </div>

    <!-- Tab 1: ä¸€é”®ç”Ÿæˆå­—å¹• -->
    <div class="tab-content active" id="tab1">
      <div class="box">
        <label>é€‰æ‹©è§†é¢‘æ–‡ä»¶: </label>
        <input type="file" id="fileInput1" accept="video/*">
      </div>
      <div class="box">
        <label>è¯­è¨€: </label>
        <select id="lang1">
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">è‹±æ–‡</option>
        </select>
        <label>æœ€å¤§å¥é•¿: </label>
        <input type="number" id="maxLen1" value="20" min="5" max="100">
      </div>
      <button onclick="upload1()">å¼€å§‹ç”Ÿæˆå­—å¹•</button>
      <h2>ç»“æœ</h2>
      <div id="output1" class="result"></div>
    </div>

    <!-- Tab 2: æ¥å£å·¥å…·ç®± -->
    <div class="tab-content" id="tab2">
      <div class="box">
        <label>è½½å…¥è§†é¢‘æ–‡ä»¶: </label>
        <input type="file" id="fileInput2" accept="video/*">
        <button onclick="probeMedia()">è¯†åˆ«è§†é¢‘ä¿¡æ¯</button>
        <button onclick="autoGenerateSubs()">è‡ªåŠ¨ç”Ÿæˆå­—å¹•</button>
      </div>
      <div class="box">
        <label>å­—å¹•å†…å®¹:</label>
        <div style="background:#f8f8f8; border-radius:8px; border:1px solid #e0e0e0; padding:12px;">
          <textarea id="subtitleEdit" class="subtitle-edit" placeholder="å¯ç¼–è¾‘å­—å¹•å†…å®¹..." style="width:100%; min-height:160px; font-family:inherit; font-size:16px; border:none; background:transparent; resize:vertical; outline:none;"></textarea>
        </div>
      </div>
      <div class="box">
        <label>å­—å¹•æ ·å¼:</label>
        <div class="row" style="flex-wrap: wrap; gap: 12px;">
          <label>å­—ä½“å</label>
          <input type="text" id="styleFont" value="å¾®è½¯é›…é»‘" style="width:100px;">
          <label>å­—å·</label>
          <input type="number" id="styleSize" value="48" min="10" max="120" style="width:60px;">
          <label>ä¸»é¢œè‰²</label>
          <input type="color" id="styleColor" value="#ffffff">
          <label>æè¾¹é¢œè‰²</label>
          <input type="color" id="styleOutlineColor" value="#000000">
          <label>æè¾¹å®½åº¦</label>
          <input type="number" id="styleOutline" value="2" min="0" max="10" style="width:50px;">
          <label>é˜´å½±</label>
          <input type="number" id="styleShadow" value="1" min="0" max="10" style="width:50px;">
          <label>å¯¹é½</label>
          <select id="styleAlign">
            <option value="2">åº•ä¸­</option>
            <option value="1">åº•å·¦</option>
            <option value="3">åº•å³</option>
            <option value="8">é¡¶ä¸­</option>
            <option value="7">é¡¶å·¦</option>
            <option value="9">é¡¶å³</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button onclick="previewVideo()">é¢„è§ˆè§†é¢‘</button>
        <button onclick="generateVideo()">ç”Ÿæˆè§†é¢‘</button>
      </div>
      <div id="output2" class="result"></div>
    </div>

    <!-- Tab 3: æ™ºèƒ½å¯¹è¯ -->
    <div class="tab-content" id="tab3">
      <div class="box">
        <label>æ‹–å…¥è§†é¢‘æ–‡ä»¶: </label>
        <input type="file" id="fileInput3" accept="video/*">
      </div>
      <div class="chat-box" id="chatBox">
        <!-- èŠå¤©å†…å®¹ -->
      </div>
      <div class="chat-input-row">
        <input type="text" id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥é—®é¢˜...">
        <button onclick="sendChat()">å‘é€</button>
      </div>
    </div>
  </div>

  <script>
    function rgbToASS(hex) {
      // #RRGGBB => &HBBGGRR
      hex = hex.replace('#','');
      if (hex.length !== 6) return '&H00FFFFFF';
      return '&H00' + hex.slice(4,6) + hex.slice(2,4) + hex.slice(0,2);
    }

    function getStyleString() {
      // è¯»å–å„é¡¹å‚æ•°ï¼Œæ‹¼æ¥ASSæ ·å¼å­—ç¬¦ä¸²
      const font = document.getElementById('styleFont').value || 'å¾®è½¯é›…é»‘';
      const size = document.getElementById('styleSize').value || '48';
      const color = rgbToASS(document.getElementById('styleColor').value || '#ffffff');
      const outlineColor = rgbToASS(document.getElementById('styleOutlineColor').value || '#000000');
      const outline = document.getElementById('styleOutline').value || '2';
      const shadow = document.getElementById('styleShadow').value || '1';
      const align = document.getElementById('styleAlign').value || '2';
      return `FontName=${font}; FontSize=${size}; PrimaryColour=${color}; OutlineColour=${outlineColor}; BorderStyle=1; Outline=${outline}; Shadow=${shadow}; Alignment=${align}`;
    }

    function setStyleInputsDefault() {
      document.getElementById('styleFont').value = 'å¾®è½¯é›…é»‘';
      document.getElementById('styleSize').value = '48';
      document.getElementById('styleColor').value = '#ffffff';
      document.getElementById('styleOutlineColor').value = '#000000';
      document.getElementById('styleOutline').value = '2';
      document.getElementById('styleShadow').value = '1';
      document.getElementById('styleAlign').value = '2';
    }
    async function autoGenerateSubs() {
      if (!videoFile2) {
        alert("è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
        return;
      }
      document.getElementById("output2").innerText = "â³ æ­£åœ¨è¯†åˆ«éŸ³é¢‘å¹¶ç”Ÿæˆå­—å¹•...";
      const formData = new FormData();
      formData.append("file", videoFile2);
      formData.append("lang", "zh"); // å¯æ ¹æ®éœ€è¦è®¾ç½®è¯­è¨€
      try {
        const resp = await fetch("http://127.0.0.1:8000/asr/", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output2").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return;
        }
        const result = await resp.json();
  // å¡«å……å­—å¹•å†…å®¹ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  document.getElementById("subtitleEdit").value = JSON.stringify(result, null, 2);
  setStyleInputsDefault();
  document.getElementById("output2").innerText = "âœ… å­—å¹•å·²è‡ªåŠ¨ç”Ÿæˆï¼Œé»˜è®¤æ ·å¼å·²è½½å…¥ï¼Œå¯ç¼–è¾‘å’Œåç»­å¤„ç†ã€‚";
      } catch (err) {
        document.getElementById("output2").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
      }
    }
    function showTab(idx) {
      document.querySelectorAll('.tab').forEach((tab, i) => tab.classList.toggle('active', i === idx));
      document.querySelectorAll('.tab-content').forEach((tab, i) => tab.classList.toggle('active', i === idx));
    }

    // Tab 1: ä¸€é”®ç”Ÿæˆå­—å¹•
    async function upload1() {
      const fileInput = document.getElementById("fileInput1");
      if (!fileInput.files.length) {
        alert("è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
        return;
      }
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("lang", document.getElementById("lang1").value);
      formData.append("max_len", document.getElementById("maxLen1").value);
      document.getElementById("output1").innerText = "â³ æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...";
      try {
        const resp = await fetch("http://127.0.0.1:8000/pipeline/", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output1").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return;
        }
        const result = await resp.json();
        let html = `
          âœ… æˆåŠŸï¼<br><br>
          ğŸ¬ åª’ä½“ä¿¡æ¯: <pre>${JSON.stringify(result.media_info, null, 2)}</pre>
          ğŸ§ éŸ³é¢‘è·¯å¾„: ${result.audio_path}<br>
          ğŸ“ å­—å¹•æ ·ä¾‹: <pre>${JSON.stringify(result.subs_sample, null, 2)}</pre><br>
          ğŸ“„ <a href="${result.srt_url}" target="_blank">ä¸‹è½½ SRT å­—å¹•</a>
          ğŸ“„ <a href="${result.ass_url}" target="_blank">ä¸‹è½½ ASS å­—å¹•</a>
          ğŸ‘€ <a href="${result.preview_url}" target="_blank">é¢„è§ˆè§†é¢‘ (å¤–æŒ‚å­—å¹•)</a>
          ğŸ”¥ <a href="${result.final_url}" target="_blank">ç¡¬å­—å¹•è§†é¢‘</a>
        `;
        document.getElementById("output1").innerHTML = html;
      } catch (err) {
        document.getElementById("output1").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
      }
    }

    // Tab 2: æ¥å£å·¥å…·ç®±ï¼ˆAPIå¯¹æ¥ï¼‰
    let videoFile2 = null;
    let assBlob = null;

    document.getElementById("fileInput2").addEventListener("change", function(e) {
      videoFile2 = e.target.files[0] || null;
    });

    async function probeMedia() {
      if (!videoFile2) {
        alert("è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
        return;
      }
      const formData = new FormData();
      formData.append("file", videoFile2);
      document.getElementById("output2").innerText = "â³ æ­£åœ¨è¯†åˆ«è§†é¢‘ä¿¡æ¯...";
      try {
        const resp = await fetch("http://127.0.0.1:8000/probe/", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output2").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return;
        }
        const result = await resp.json();
        document.getElementById("output2").innerHTML = "âœ… åª’ä½“ä¿¡æ¯:<br><pre>" + JSON.stringify(result, null, 2) + "</pre>";
      } catch (err) {
        document.getElementById("output2").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
      }
    }

    async function generateASS() {
      // ç”ŸæˆASSå­—å¹•æ–‡ä»¶ï¼Œè¿”å›Blob
      const subsText = document.getElementById("subtitleEdit").value.trim();
      // å§‹ç»ˆæ ¹æ®é¡µé¢æ ·å¼è¡¨å•ç”ŸæˆASSæ ·å¼å­—ç¬¦ä¸²
      const style = getStyleString();
      if (!subsText) {
        alert("è¯·å¡«å†™å­—å¹•å†…å®¹ï¼");
        return null;
      }
      let subsObj;
      try {
        subsObj = JSON.parse(subsText);
      } catch {
        subsObj = { events: [{ text: subsText }] };
      }
      // å¼ºåˆ¶è¦†ç›–æ ·å¼å‚æ•°
      subsObj.style = style;
      document.getElementById("output2").innerText = "â³ æ­£åœ¨ç”ŸæˆASSå­—å¹•...";
      try {
        const resp = await fetch("http://127.0.0.1:8000/ass/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(subsObj)
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output2").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return null;
        }
        const result = await resp.json();
        // ä¸‹è½½ASSæ–‡ä»¶
        let assPath = result.ass_path.replace(/\\/g, '/');
        if (!assPath.startsWith('/')) assPath = '/' + assPath;
        const assUrl = "http://127.0.0.1:8000" + assPath;
        const assResp = await fetch(assUrl);
        const assData = await assResp.blob();
        assBlob = assData;
        document.getElementById("output2").innerHTML = `âœ… ASSå­—å¹•å·²ç”Ÿæˆ: <a href="${assUrl}" target="_blank">ä¸‹è½½ASS</a>`;
        return assBlob;
      } catch (err) {
        document.getElementById("output2").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
        return null;
      }
    }

    async function previewVideo() {
      if (!videoFile2) {
        alert("è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
        return;
      }
      // å…ˆç”ŸæˆASSå­—å¹•
      const assData = await generateASS();
      console.log("assData:", assData);
      if (!assData) return;
      const formData = new FormData();
      formData.append("file", videoFile2);
      formData.append("ass_file", new File([assData], "subtitle.ass", { type: "text/plain" }));
      document.getElementById("output2").innerText = "â³ æ­£åœ¨ç”Ÿæˆé¢„è§ˆè§†é¢‘...";
      try {
        const resp = await fetch("http://127.0.0.1:8000/preview/", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output2").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return;
        }
        const result = await resp.json();
  let previewPath = result.preview_path.replace(/\\/g, '/');
  if (!previewPath.startsWith('/')) previewPath = '/' + previewPath;
  const previewUrl = "http://127.0.0.1:8000" + previewPath;
  document.getElementById("output2").innerHTML = `âœ… é¢„è§ˆè§†é¢‘å·²ç”Ÿæˆ: <a href="${previewUrl}" target="_blank">ç‚¹å‡»é¢„è§ˆ</a>`;
      } catch (err) {
        document.getElementById("output2").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
      }
    }

    async function generateVideo() {
      if (!videoFile2) {
        alert("è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
        return;
      }
      // å…ˆç”ŸæˆASSå­—å¹•
      const assData = await generateASS();
      if (!assData) return;
      const formData = new FormData();
      formData.append("file", videoFile2);
      formData.append("ass_file", new File([assData], "subtitle.ass", { type: "text/plain" }));
      document.getElementById("output2").innerText = "â³ æ­£åœ¨ç”Ÿæˆç¡¬å­—å¹•è§†é¢‘...";
      try {
        const resp = await fetch("http://127.0.0.1:8000/burn/", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          const text = await resp.text();
          document.getElementById("output2").innerText = "âŒ é”™è¯¯: " + resp.status + "\n" + text;
          return;
        }
        const result = await resp.json();
  let outputPath = result.output_path.replace(/\\/g, '/');
  if (!outputPath.startsWith('/')) outputPath = '/' + outputPath;
  const outputUrl = "http://127.0.0.1:8000" + outputPath;
  document.getElementById("output2").innerHTML = `âœ… è§†é¢‘å·²ç”Ÿæˆ: <a href="${outputUrl}" target="_blank">ä¸‹è½½/é¢„è§ˆ</a>`;
      } catch (err) {
        document.getElementById("output2").innerText = "âŒ è¯·æ±‚å¤±è´¥: " + err;
      }
    }

    // Tab 3: æ™ºèƒ½å¯¹è¯ï¼ˆä»…å‰ç«¯UIï¼Œéœ€åç«¯APIé…åˆï¼‰
    let chatHistory = [];
    function sendChat() {
      const input = document.getElementById("chatInput").value.trim();
      if (!input) return;
      chatHistory.push({ role: "user", text: input });
      updateChatBox();
      document.getElementById("chatInput").value = "";
      // æ¨¡æ‹ŸAIæ€è€ƒ
      chatHistory.push({ role: "ai", text: "ğŸ¤” æ­£åœ¨æ€è€ƒ..." });
      updateChatBox();
      setTimeout(() => {
        chatHistory.pop();
        chatHistory.push({ role: "ai", text: "[ç¤ºä¾‹å›å¤] è¿™æ˜¯AIå¯¹ä½ çš„é—®é¢˜çš„å›å¤ã€‚" });
        updateChatBox();
      }, 1200);
    }
    function updateChatBox() {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = chatHistory.map(msg =>
        `<div class="chat-msg"><span class="${msg.role === 'user' ? 'chat-user' : 'chat-ai'}">${msg.role === 'user' ? 'ä½ ' : 'AI'}:</span> ${msg.text}</div>`
      ).join("");
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
